<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Enregistrement Vid√©o d'Urgence</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      text-align: center;
      margin: 0;
      padding: 20px;
      background-color: #f9f9f9;
    }

    h1 {
      font-size: 1.5em;
      margin-bottom: 20px;
    }

    #videoPlayer {
      width: 100%;
      max-width: 480px;
      height: auto;
      background-color: #000;
      border-radius: 8px;
    }

    .btn-container {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 10px;
      margin-top: 20px;
    }

    button {
      flex: 1 1 140px;
      padding: 12px;
      font-size: 1rem;
      cursor: pointer;
      background-color: #007BFF;
      color: white;
      border: none;
      border-radius: 8px;
      transition: background-color 0.3s ease;
    }

    button:hover {
      background-color: #0056b3;
    }

    @media (max-width: 480px) {
      button {
        flex: 1 1 100%;
      }
    }
  </style>
</head>
<body>
  <h1>Vid√©o d'urgence</h1>
  <video id="videoPlayer" autoplay playsinline></video>

  <div class="btn-container">
    <button id="startRecordingBtn">D√©marrer la vid√©o</button>
    <button id="stopRecordingBtn" style="display:none;">Arr√™ter</button>
    <button id="pauseResumeBtn" style="display:none;">Pause</button>
    <button id="closeBtn">Fermer</button>
  </div>

  <script>
    let mediaRecorder;
    let videoStream;
    let chunks = [];
    let isRecording = false;

    const ACCESS_TOKEN = '...'; // üõë Raccourci ici volontairement

    document.getElementById('startRecordingBtn').addEventListener('click', startRecording);
    document.getElementById('stopRecordingBtn').addEventListener('click', stopRecording);
    document.getElementById('pauseResumeBtn').addEventListener('click', togglePauseResume);
    document.getElementById('closeBtn').addEventListener('click', () => {
      window.location.href = 'monjournal.html';
    });

    async function startRecording() {
      try {
        videoStream = await navigator.mediaDevices.getUserMedia({ video: true });
        document.getElementById('videoPlayer').srcObject = videoStream;

        mediaRecorder = new MediaRecorder(videoStream, { mimeType: 'video/webm' });
        mediaRecorder.ondataavailable = (e) => chunks.push(e.data);
        mediaRecorder.onstop = saveVideo;
        mediaRecorder.start();

        isRecording = true;
        toggleButtons(true);
      } catch (error) {
        console.error("Erreur d'acc√®s √† la cam√©ra :", error);
        alert("V√©rifiez les permissions cam√©ra.");
      }
    }

    function stopRecording() {
      if (mediaRecorder && mediaRecorder.state !== "inactive") {
        mediaRecorder.stop();
      }
      if (videoStream) {
        videoStream.getTracks().forEach(track => track.stop());
      }

      isRecording = false;
      toggleButtons(false);

      alert("Vid√©o en cours d'enregistrement...");
    }

    function togglePauseResume() {
      const pauseBtn = document.getElementById('pauseResumeBtn');
      if (mediaRecorder.state === 'recording') {
        mediaRecorder.pause();
        pauseBtn.textContent = 'Reprendre';
      } else {
        mediaRecorder.resume();
        pauseBtn.textContent = 'Pause';
      }
    }

    async function saveVideo() {
      const blob = new Blob(chunks, { type: 'video/webm' });
      const fileSize = blob.size;
      const maxFileSize = 350 * 1024 * 1024;

      if (fileSize > maxFileSize) {
        alert("Vid√©o trop lourde. R√©duisez la dur√©e.");
        return;
      }

      const fileName = `video_urgence_${new Date().toISOString().replace(/:/g, '-')}.webm`; 
      const savePath = `/ToxDetect backup/${fileName}`;

      // Optionnel : t√©l√©chargement local
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = fileName;
      a.click();

      // Envoi Dropbox
      uploadToDropbox(blob, savePath);
    }

    function uploadToDropbox(blob, path) {
      fetch('https://content.dropboxapi.com/2/files/upload', {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${ACCESS_TOKEN}`,
          'Content-Type': 'application/octet-stream',
          'Dropbox-API-Arg': JSON.stringify({
            path,
            mode: 'add',
            autorename: true,
            mute: false
          })
        },
        body: blob
      })
      .then(response => response.json())
      .then(data => {
        console.log("Upload r√©ussi :", data);
        alert("Vid√©o sauvegard√©e sur Dropbox !");
      })
      .catch(error => {
        console.error("Erreur Dropbox :", error);
        alert("Erreur lors de l'envoi vers Dropbox.");
      });
    }

    function toggleButtons(isRecording) {
      document.getElementById('startRecordingBtn').style.display = isRecording ? 'none' : 'inline-block';
      document.getElementById('stopRecordingBtn').style.display = isRecording ? 'inline-block' : 'none';
      document.getElementById('pauseResumeBtn').style.display = isRecording ? 'inline-block' : 'none';
    }
  </script>
</body>
</html>
